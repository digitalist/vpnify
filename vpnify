#!/bin/bash

NETNS=$(ip netns show | cut -d' ' -f1 | grep '^vpnify$')
GW=$(ip route | grep default | sed 's/.*dev \(.*\)/\1/')

if [ "$NETNS" == "" ]; then
    # setup netns
    NETNS="vpnify"

    sudo ip netns add $NETNS
    sudo ip netns exec $NETNS ip link set dev lo up   
    
    sudo ip link add veth0 type veth peer name veth1
    sudo ip link set veth1 netns $NETNS

    sudo ip netns exec $NETNS ip addr add 10.1.1.1/24 dev veth1
    sudo ip addr add 10.1.1.2/24 dev veth0

    sudo ip netns exec $NETNS ip link set veth1 up
    sudo ip link set veth0 up

    sudo ip netns exec $NETNS ip route add default via 10.1.1.2 dev veth1 

    echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward > /dev/null
    sudo iptables -t nat -C POSTROUTING -s 10.1.1.0/24 -o $GW -j MASQUERADE 2> /dev/null
    
    if [ $? != 0 ]; then
        sudo iptables -t nat -A POSTROUTING -s 10.1.1.0/24 -o $GW -j MASQUERADE
    fi
fi

sudo -E ip netns exec $NETNS sudo -u $USER $*

PIDS=$(sudo find -L /proc/[1-9]*/task/*/ns/net -samefile /run/netns/"$NETNS" | cut -d/ -f5)

if [ "$PIDS" == "" ]; then
    sudo ip netns del $NETNS
fi
